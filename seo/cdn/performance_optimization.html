
<!-- CDN Performance Optimization Script -->
<script>
(function() {
    // DNS prefetch for external resources
    function addDNSPrefetch(domains) {
        domains.forEach(domain => {
            const link = document.createElement('link');
            link.rel = 'dns-prefetch';
            link.href = domain;
            document.head.appendChild(link);
        });
    }
    
    // Preload critical resources
    function preloadCriticalResources() {
        const criticalResources = [
            {href: '/styles.css', as: 'style'},
            {href: '/blog-unified.css', as: 'style'},
            {href: '/fonts/roboto.woff2', as: 'font', type: 'font/woff2', crossorigin: 'anonymous'}
        ];
        
        criticalResources.forEach(resource => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.href = resource.href;
            link.as = resource.as;
            if (resource.type) link.type = resource.type;
            if (resource.crossorigin) link.crossOrigin = resource.crossorigin;
            document.head.appendChild(link);
        });
    }
    
    // Lazy load images with WebP support
    function setupLazyLoadingWithWebP() {
        const images = document.querySelectorAll('img[loading="lazy"]');
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    
                    // WebP support check and replacement
                    if (supportsWebP() && !img.src.includes('.webp')) {
                        const webpSrc = img.src.replace(/\.(jpg|jpeg|png)$/i, '.webp');
                        img.src = webpSrc;
                    }
                    
                    observer.unobserve(img);
                }
            });
        });
        
        images.forEach(img => imageObserver.observe(img));
    }
    
    // Check WebP support
    function supportsWebP() {
        return new Promise(resolve => {
            const webp = new Image();
            webp.onload = webp.onerror = () => resolve(webp.height === 2);
            webp.src = 'data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA';
        });
    }
    
    // Resource hints for better performance
    function addResourceHints() {
        // DNS prefetch for external domains
        addDNSPrefetch([
            'https://fonts.googleapis.com',
            'https://fonts.gstatic.com',
            'https://www.google-analytics.com',
            'https://www.googletagmanager.com'
        ]);
        
        // Preconnect to critical origins
        const preconnectDomains = [
            'https://fonts.googleapis.com',
            'https://fonts.gstatic.com'
        ];
        
        preconnectDomains.forEach(domain => {
            const link = document.createElement('link');
            link.rel = 'preconnect';
            link.href = domain;
            link.crossOrigin = 'anonymous';
            document.head.appendChild(link);
        });
    }
    
    // Service Worker for caching
    function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('SW registered:', registration);
                })
                .catch(error => {
                    console.log('SW registration failed:', error);
                });
        }
    }
    
    // Performance monitoring
    function trackCDNPerformance() {
        window.addEventListener('load', () => {
            const perfData = performance.getEntriesByType('navigation')[0];
            
            const metrics = {
                ttfb: perfData.responseStart - perfData.requestStart,
                domLoad: perfData.domContentLoadedEventEnd - perfData.navigationStart,
                fullLoad: perfData.loadEventEnd - perfData.navigationStart,
                timestamp: new Date().toISOString()
            };
            
            // Send to analytics
            if (typeof gtag !== 'undefined') {
                gtag('event', 'cdn_performance', {
                    custom_parameter_ttfb: metrics.ttfb,
                    custom_parameter_dom_load: metrics.domLoad,
                    custom_parameter_full_load: metrics.fullLoad,
                    custom_parameter_page: window.location.pathname
                });
            }
        });
    }
    
    // Initialize optimizations
    document.addEventListener('DOMContentLoaded', () => {
        addResourceHints();
        preloadCriticalResources();
        setupLazyLoadingWithWebP();
        trackCDNPerformance();
        registerServiceWorker();
    });
})();
</script>
        